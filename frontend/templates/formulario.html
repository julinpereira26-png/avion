<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario de Reserva</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-50 text-gray-800">

<main class="mx-auto max-w-6xl px-4 py-8">
  <div class="flex flex-col lg:flex-row gap-8">

    <!-- 🧍 Datos del Pasajero -->
    <section class="bg-white rounded-2xl shadow-sm border p-5 flex-1 relative">
      <div class="absolute top-4 right-5 text-sm font-semibold text-gray-600" id="contadorPasajeros">0/0</div>
      <h2 class="font-semibold text-lg mb-2">Datos del Pasajero</h2>
      <p id="infoAsientos" class="text-sm text-gray-600 mb-4"></p>

      <form id="formPasajero" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div><label class="text-sm">Primer Apellido</label><input name="apellido1" class="mt-1 w-full rounded-xl border px-3 py-2" required /></div>
        <div><label class="text-sm">Tipo Documento</label><select name="tipoDoc" class="mt-1 w-full rounded-xl border px-3 py-2" required><option value="">Selecciona...</option><option>CC</option><option>CE</option><option>TI</option></select></div>
        <div><label class="text-sm">Segundo Apellido</label><input name="apellido2" class="mt-1 w-full rounded-xl border px-3 py-2" required /></div>
        <div><label class="text-sm">Número Documento</label><input name="numDoc" class="mt-1 w-full rounded-xl border px-3 py-2" required /></div>
        <div><label class="text-sm">Nombre(s)</label><input name="nombres" class="mt-1 w-full rounded-xl border px-3 py-2" required /></div>
        <div><label class="text-sm">Celular</label><input name="celular" class="mt-1 w-full rounded-xl border px-3 py-2" type="tel" required /></div>
        <div><label class="text-sm">Fecha de nacimiento</label><input name="fecha_nacimiento" type="date" class="mt-1 w-full rounded-xl border px-3 py-2" required /></div>
        <div><label class="text-sm">Género</label><select name="genero" class="mt-1 w-full rounded-xl border px-3 py-2" required><option value="">Selecciona...</option><option value="M">Masculino</option><option value="F">Femenino</option><option value="O">Otro</option></select></div>
        <div class="sm:col-span-2"><label class="text-sm">Correo</label><input name="correo" class="mt-1 w-full rounded-xl border px-3 py-2" type="email" required /></div>
        <div class="sm:col-span-2 flex justify-end">
          <button type="submit" class="mt-2 px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition">Guardar pasajero</button>
        </div>
      </form>
    </section>

    <!-- 💳 Datos del Pagante -->
    <section class="bg-white rounded-2xl shadow-sm border p-5 flex-1">
      <h2 class="font-semibold text-lg mb-2">Datos del Pagante</h2>
      <form id="formPagante" class="space-y-4">
        <div><label class="text-sm">Nombre Completo</label><input name="nombre" class="mt-1 w-full rounded-xl border px-3 py-2" required /></div>
        <div class="grid grid-cols-3 gap-3">
          <div><label class="text-sm">Tipo Doc.</label><select name="tipoDoc" class="mt-1 w-full rounded-xl border px-3 py-2" required><option value="">Selecciona...</option><option>CC</option><option>CE</option></select></div>
          <div class="col-span-2 flex items-end"><input name="numDoc" class="w-full rounded-xl border px-3 py-2" placeholder="Número" required /></div>
        </div>
        <div><label class="text-sm">Celular</label><input name="celular" class="mt-1 w-full rounded-xl border px-3 py-2" type="tel" required /></div>
        <div class="grid grid-cols-3 gap-3">
          <div class="col-span-2"><label class="text-sm">Método de Pago</label><select name="metodo" class="mt-1 w-full rounded-xl border px-3 py-2" required><option value="">Selecciona...</option><option>Tarjeta débito</option><option>Tarjeta crédito</option><option>PSE</option></select></div>
          <div class="flex items-end"><button type="button" id="btnPagar" onclick="confirmarPago()" disabled class="w-full rounded-xl bg-gray-400 text-white py-2 cursor-not-allowed transition">Pagar</button></div>
        </div>
        <label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" id="checkTerminos" class="rounded border-gray-300" required><span>Acepto términos y condiciones</span></label>
      </form>
    </section>

  </div>
</main>

<script>
const url = "https://wait-demand-remedies-covers.trycloudflare.com"; // tu túnel Cloudflare

const info = document.getElementById("infoAsientos");
const contador = document.getElementById("contadorPasajeros");
const btnPagar = document.getElementById("btnPagar");
const formPasajero = document.getElementById("formPasajero");

const asientos = JSON.parse(localStorage.getItem("asientosSeleccionados") || "[]");
const id_vuelo = localStorage.getItem("id_vuelo");
const cantidad = asientos.length;

let pasajeros = [];
let actual = 0;

contador.textContent = `0/${cantidad}`;
info.textContent = cantidad === 0
  ? "No se seleccionaron asientos."
  : `Registrando pasajero del asiento ${asientos[0]}`;

formPasajero.addEventListener("submit", e => {
  e.preventDefault();
  if (actual >= cantidad) return Swal.fire("¡Listo!", "Ya registraste todos los pasajeros.", "info");

  const data = Object.fromEntries(new FormData(e.target).entries());
  data.asiento = asientos[actual];
  pasajeros.push(data);

  actual++;
  contador.textContent = `${actual}/${cantidad}`;

  if (actual < cantidad) {
    info.textContent = `Registrando pasajero del asiento ${asientos[actual]} (${actual + 1}/${cantidad})`;
  } else {
    info.textContent = `Todos los pasajeros registrados (${cantidad}/${cantidad})`;
    formPasajero.querySelectorAll("input, select, button").forEach(el => el.disabled = true);
    btnPagar.disabled = false;
    btnPagar.classList.remove("bg-gray-400", "cursor-not-allowed");
    btnPagar.classList.add("bg-indigo-600", "hover:bg-indigo-700");
  }

  e.target.reset();
});

async function confirmarPago() {
  if (pasajeros.length < cantidad) {
    return Swal.fire("Error", "Registra todos los pasajeros antes de pagar.", "warning");
  }

  const paganteForm = document.getElementById("formPagante");
  if (!paganteForm.reportValidity()) return;

  const pagante = Object.fromEntries(new FormData(paganteForm).entries());
  const bodyReserva = {
    pagador: {
      nombre: pagante.nombre,
      tipo_doc: pagante.tipoDoc,
      num_doc: pagante.numDoc,
      correo: pagante.correo || "",
      celular: pagante.celular
    },
    pasajeros: pasajeros.map(p => ({
      primer_apellido: p.apellido1,
      segundo_apellido: p.apellido2,
      nombres: p.nombres,
      fecha_nacimiento: p.fecha_nacimiento,
      genero: p.genero,
      tipo_documento: p.tipoDoc,
      num_documento: p.numDoc,
      celular: p.celular,
      correo: p.correo,
      asiento: p.asiento
    }))
  };

  try {
    const resReserva = await fetch(`${url}/vuelo/${id_vuelo}/reservar`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyReserva)
    });
    const dataReserva = await resReserva.json();
    if (!resReserva.ok) throw new Error(dataReserva.error || "Error al crear reserva");
    const codigo_reserva = dataReserva.codigo_reserva;

    const resPago = await fetch(`${url}/pago/${codigo_reserva}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ metodo: pagante.metodo || "TARJETA" })
    });
    const dataPago = await resPago.json();
    if (!resPago.ok) throw new Error(dataPago.error || "Error al procesar pago");

    Swal.fire({
      title: "¡Pago exitoso!",
      html: `Código de reserva: <b>${codigo_reserva}</b><br>Total: <b>$${dataPago.monto}</b>`,
      icon: "success",
      showCancelButton: true,
      confirmButtonText: "Descargar tiquete",
      cancelButtonText: "Cerrar"
    }).then(async result => {
      if (result.isConfirmed) {
        try {
          const resTiq = await fetch(`${url}/tiquete/${codigo_reserva}`);
          if (!resTiq.ok) throw new Error("No se pudo descargar el tiquete");
          const blob = await resTiq.blob();
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = `tiquete_${codigo_reserva}.pdf`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
        } catch (e) {
          Swal.fire("Error", e.message, "error");
        }
      }

      localStorage.clear();
      window.location.href = "index.html";
    });

  } catch (err) {
    console.error(err);
    Swal.fire("Error", err.message || "Ocurrió un error inesperado.", "error");
  }
}
</script>

</body>
</html>
